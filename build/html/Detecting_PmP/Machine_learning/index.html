

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Machine Learning &mdash; PmPWorld  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Southern California" href="../../PmP_database/Southern_California/index.html" />
    <link rel="prev" title="Phase Identification" href="../Phase_identification/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> PmPWorld
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Introduction/Earth_model/index.html">Earth Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Introduction/Synthetic_perspective/index.html">Synthetic Perspective</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Introduction/Field_perspective/index.html">Field Perspective</a></li>
</ul>
<p class="caption"><span class="caption-text">Previous Study</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Previous_study/California/index.html">California</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Previous_study/Japan/index.html">Japan</a></li>
</ul>
<p class="caption"><span class="caption-text">Detecting PmP</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Waveform_stacking/index.html">Waveform Stacking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Phase_identification/index.html">Phase Identification</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Machine Learning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pmpnet-structure">PmPNet Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#loss-function-of-pmpnet">Loss Function of PmPNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="#performance-of-pmpnet">Performance of PmPNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="#use-pmpnet-to-identify-pmp-phase">Use PmPNet to Identify PmP Phase</a></li>
<li class="toctree-l2"><a class="reference internal" href="#use-pmp-traveltime-net-to-predict-pmp-traveltime">Use PmP-traveltime-Net to Predict PmP Traveltime</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">PmP Database</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../PmP_database/Southern_California/index.html">Southern California</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PmP_database/Northern_California/index.html">Northern California</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PmPWorld</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Machine Learning</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/Detecting_PmP/Machine_learning/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="machine-learning">
<h1>Machine Learning<a class="headerlink" href="#machine-learning" title="Permalink to this headline">¶</a></h1>
<p>By utilizing the high-quality PmP dataset (10,192 manual picks by <a class="reference external" href="https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/2021JB023033">Li et al., 2002</a>) in southern California,
we further develop <strong>PmPNet</strong> (<a class="reference external" href="https://doi.org/10.48550/arXiv.2112.07655">Ding et al., 2002</a>), a deep-neural-network-based algorithm to automatically
identify PmP waves efficiently. <strong>PmPNet</strong> applies similar techniques in the machine learning community to address the unbalancement
of PmP datasets. The trained optimal <strong>PmPNet</strong> can efficiently achieve high precision and high recall simultaneously to automatically
identify PmP waves from a massive seismic database.</p>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../../_images/PmPNet_Trainflow.png"><img alt="Training flow of PmPNet." src="../../_images/PmPNet_Trainflow.png" style="width: 100.0%;" /></a>
<p class="caption"><span class="caption-text">PmPNet training flow: (i) one batch of data points is fed into <strong>PmPNet</strong>, and the loss between the <strong>PmPNet</strong> output and the true
labels is computed; and (ii) the optimizer reads in the loss and update the trainable parameters of <strong>PmPNet</strong>. One epoch of
training consists of continuing this iteration until the whole dataset has been tranversed. The training phase for <strong>PmPNet</strong>
is complete when the pre-selected maximum number of epochs is reached.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="pmpnet-structure">
<h2>PmPNet Structure<a class="headerlink" href="#pmpnet-structure" title="Permalink to this headline">¶</a></h2>
<p><strong>We implemented PmPNet as a convolutional residual autoencoder (RAE) with an additional prediction module.</strong>
In our construction, the input of the <strong>PmPNet</strong> is a one-dimensional vector of length 297. It combines three parts:
<em>envelope</em>, <em>dist</em>, <em>evdp</em>. The length 281 <em>envelope</em> is the normalized envelope of the vertical component of seismic signals,
which has been resampled at 40 Hz and covers the time window from 2 s before to 5 s after the observed P-wave arrival.
<em>Dist</em> refers to the epicentral distance, and <em>evdp</em> refers to the focal depth, both being repeated 8 times and concatenated
to the end of the signal. The number of duplication 8 is chosen according to our experiments, and the final results presented in this
paper are not sensitive to this selection.</p>
<div class="math notranslate nohighlight">
\[input \ x := (envelope_{1},...,envelope_{281},\underbrace{dist,...,dist}_{8 \ times},\underbrace{evdp,...,evdp}_{8 \ times})\]</div>
<p><strong>PmPNet</strong> outputs three quantities: (i) the recovered input, (ii) the PmP travel time t (a positive real number), and (iii) the PmP
probability p, a real number in [0, 1] representing the probability that the input seismic signal contains a PmP phase.
<strong>PmPNet</strong> includes three major substructures: an encoder, a decoder, and a predictor. Similar to a standard AE, the encoder and
the decoder are trained to regenerate the input. We train the predictor to read the latent variable (generated by the encoder)
to predict the PmP probability p and travel time t. To be more precise, let <em>x̃</em> be the output of the decoder, i.e., the recovered input.
Then <em>z = Encoder(x)</em>, <em>x̃ = Decoder(z)</em>, and <em>(p, t) = Predictor(z)</em>.</p>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="../../_images/PmPNet_Structure.jpg"><img alt="The main architecture of the PmPNet." src="../../_images/PmPNet_Structure.jpg" style="width: 100.0%;" /></a>
<p class="caption"><span class="caption-text">The main architecture of the PmPNet and the data flow inside the network: The input of the PmPNet is a one-dimensional vector
combining three parts: signal envelope, epicentral distance, and focal depth; PmPNet outputs three quantities: the recovered
signal (including signal envelope, epicentral distance, and focal depth), the PmP probability p and the PmP travel time t;
PmPNet includes three major substructures: an encoder, a decoder, and a predictor.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="loss-function-of-pmpnet">
<h2>Loss Function of PmPNet<a class="headerlink" href="#loss-function-of-pmpnet" title="Permalink to this headline">¶</a></h2>
<p>Given a training input set <span class="math notranslate nohighlight">\(\{x_{i}\}^{N}_{i=1}\)</span> with <em>N</em> data points, the corresponding PmP label <span class="math notranslate nohighlight">\(\{p_{true,i}\}^{N}_{i=1}\)</span>
and PmP travel time <span class="math notranslate nohighlight">\(\{t_{true,i}\}_{i=1}^{N}\)</span>, we can optimize a <strong>PmPNet</strong> with trainable parameters set <em>θ</em>. Three
different loss functions (<span class="math notranslate nohighlight">\(l_{1}\)</span>, <span class="math notranslate nohighlight">\(l_{2}\)</span>, <span class="math notranslate nohighlight">\(l_{3}\)</span>) are utilized for encoder-decoder, classification and travel time training respectively.
The total training loss of <strong>PmPNet</strong> is the sum of three individual losses:</p>
<div class="math notranslate nohighlight">
\[Loss(θ) := \frac{1}{N}\sum_{i=1}^{N}[l_{1}(x̃_{i}(θ,x_{i}),x_{i})+l_{2}(p_{i}(θ,x_{i}),p_{true,i})+l_{3}(t_{i}(θ,x_{i}),t_{true,i})]\]</div>
<p>The variables involved are summarized as follows:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(x_{i}\)</span> is the input datum and <span class="math notranslate nohighlight">\(x̃_{i}(θ,x_{i}) := Decoder_{θ}(Encoder_{θ}(x_{i}))\)</span> is the recovered datum by the encoder-decoder pair.</p></li>
<li><p><span class="math notranslate nohighlight">\(p_{true,i}\)</span> is the true PmP label picked by experts, which is either 0 or 1. Here <span class="math notranslate nohighlight">\(p_{true,i}=1\)</span> means that <span class="math notranslate nohighlight">\(x_{i}\)</span> has a PmP phase, while <span class="math notranslate nohighlight">\(p_{true,i}=0\)</span> means that <span class="math notranslate nohighlight">\(x_{i}\)</span> does not have a PmP phase.</p></li>
<li><p><span class="math notranslate nohighlight">\(t_{true,i}\)</span> is the true PmP travel time, which is either manually picked for those labeled with PmP or theoretically computed by using the HK model (<a class="reference external" href="https://strike.scec.org/scecpedia/Hadley-Kanamori">Hadley &amp; Kanamori, 1977</a>) for those labeled with non-PmP.</p></li>
<li><p><span class="math notranslate nohighlight">\((p_{i},t_{i}):=Predictor_{θ}(Encoder_{θ}(x_{i}))\)</span> with <span class="math notranslate nohighlight">\(p_{i}(θ,x_{i})\)</span> and <span class="math notranslate nohighlight">\(t_{i}(θ,x_{i})\)</span> being the PmP probability and the PmP travel time, respectively.</p></li>
</ul>
<p>Besides, each loss function is defined as:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(l_{1}(x,x̃):=||x − x̃||_{1}\)</span> is the L1 loss between input datum and recovered datum.</p></li>
<li><p><span class="math notranslate nohighlight">\(l_{2}(p,p_{true}):=-ωp_{true}log(p(x))-(1-p_{true})log(1-p(x))\)</span> is the weighted cross-entropy loss with the weight ω chosen to be 20 balancing the importance of precision and recall.</p></li>
<li><p><span class="math notranslate nohighlight">\(l_{3}(t,t_{true}):=||t − t_{true}||_{1}\)</span> is absolute difference between the true traveltime and predicted traveltime.</p></li>
</ul>
</div>
<div class="section" id="performance-of-pmpnet">
<h2>Performance of PmPNet<a class="headerlink" href="#performance-of-pmpnet" title="Permalink to this headline">¶</a></h2>
<p>The validation performances of <strong>PmPNet</strong> shows that The proposed <strong>PmPNet</strong> can reach high precision(96.6%) and recall(85.3%) simultaneously.
The average travel time absolute difference is around 0.33s, while maximum difference constantly stays within 5s.</p>
<div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="../../_images/PmPNet_Performance1.png"><img alt="Performance of PmPNet." src="../../_images/PmPNet_Performance1.png" style="width: 100.0%;" /></a>
<p class="caption"><span class="caption-text">The total training loss decreases as the epoch increases.
The precision-recall curve on validation set.
The PmP traveltime residual between the predicted and manually picked ones on validation set.</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>The recovered input can capture most of the patterns from the input signal, which indicates the latent variable is indeed a good representation of the input.</p>
<div class="figure align-center" id="id4">
<a class="reference internal image-reference" href="../../_images/PmPNet_Performance2.png"><img alt="Performance of PmPNet." src="../../_images/PmPNet_Performance2.png" style="width: 100.0%;" /></a>
<p class="caption"><span class="caption-text">The <strong>PmPNet</strong> recovered input and the input component on validation set.</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>Applying the trained <strong>PmPNet</strong> to the 19-year long vertical-component seismic data from January 2000 to December 2018, we are going to automatically
identify the waveforms which could contain high-quality PmP waves. To achieve the goal, we select the waveforms with the PmP label
with a probability of larger than 0.8. Result shows that the trained <strong>PmPNet</strong> has successfully recalled the most PmP waves (larger than 96 %) before 2011, and even for the seismic data after 2010 which are not involved in training the <strong>PmPNet</strong>, there is also a high recall value of larger than 85 %.</p>
<div class="figure align-center" id="id5">
<a class="reference internal image-reference" href="../../_images/PmPNet_Performance3.png"><img alt="Performance of PmPNet." src="../../_images/PmPNet_Performance3.png" style="width: 100.0%;" /></a>
<p class="caption"><span class="caption-text">PmP picks when applying the trained <strong>PmPNet</strong> to real data. Blue bars show the picked PmP waves each year by the two-stage workflow,
orange bars show the identified PmP waves each year by the <strong>PmPNet</strong> with the probability of greater than 0.8, and green bars show
the overlapped PmP waves each year between the two identifiers.</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="use-pmpnet-to-identify-pmp-phase">
<h2>Use PmPNet to Identify PmP Phase<a class="headerlink" href="#use-pmpnet-to-identify-pmp-phase" title="Permalink to this headline">¶</a></h2>
<p><strong>Build the Running Environment</strong></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>PmPNet</strong> is designed to operate on <a class="reference external" href="https://developer.nvidia.com/cuda-toolkit">CUDA</a> with at least 2,100-MiB memory.
And Python version is better to choose 3.8.</p>
</div>
<p>Assuming you have <a class="reference external" href="https://www.anaconda.com/">Anaconda</a> already, set up a new environment named e.g., <strong>PmPNet</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "$ ";
}
</style><span class="prompt1">conda create -n PmPNet <span class="nv">python</span><span class="o">=</span><span class="m">3</span>.8</span>
</pre></div></div><p>Install <a class="reference external" href="https://jupyter.org/">JupyterLab</a> or <a class="reference external" href="https://jupyter.org/">Jupyter Notebook</a> which is used to run <strong>PmPNet</strong> then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">conda install -c conda-forge jupyterlab</span>
</pre></div></div><p>Install <a class="reference external" href="https://pandas.pydata.org/">pandas</a> to facilitate file manipulations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">pip install wheel</span>
<span class="prompt1">pip install pandas</span>
</pre></div></div><p>Install <a class="reference external" href="https://docs.obspy.org/#">ObsPy</a> which is used to process seismic data then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">conda install -c conda-forge obspy</span>
</pre></div></div><p>Install <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a> which is used to prepare the
train and validation data (e.g., standardization, randomly allocate train and validation data) then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">conda install -c conda-forge scikit-learn</span>
</pre></div></div><p>Install <a class="reference external" href="https://pypi.org/project/pickle-mixin/">pickle-mixin</a> which is used to transform a complex object
into a byte stream and speed up data manipulation (e.g., reading and writing) then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">pip install pickle-mixin</span>
</pre></div></div><p>Install <a class="reference external" href="https://pytorch.org/">PyTorch</a> which is used to construct and run <strong>PmPNet</strong> then:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Be careful about the software compatibility between <strong>PyTorch</strong> and <strong>CUDA</strong>.
You can check your <strong>CUDA</strong> version through <code class="docutils literal notranslate"><span class="pre">nvidia-smi</span></code> (assume you have installed the NVIDIA Linux driver),
then choose a suitable <strong>PyTorch</strong> version at <code class="docutils literal notranslate"><span class="pre">https://anaconda.org/pytorch/pytorch/files</span></code>.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">conda install -c pytorch <span class="nv">pytorch</span><span class="o">=</span><span class="m">1</span>.11.0<span class="o">=</span>py3.8_cuda11.3_cudnn8.2.0_0</span>
</pre></div></div><p><strong>Train PmPNet</strong></p>
<ul class="simple">
<li><p>Device configuration, Hyper-parameters setting, paths setting for data and result folders:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt2:before {
  content: " ";
}
</style><span class="prompt2"><span class="kn">import</span> <span class="nn">torch</span></span>
<span class="prompt2"><span class="kn">import</span> <span class="nn">os</span></span>
<span class="prompt2"><span class="kn">import</span> <span class="nn">PmPNet</span> <span class="k">as</span> <span class="nn">PN</span></span>
<span class="prompt2"></span>
<span class="prompt2"><span class="c1"># Device configuration</span></span>
<span class="prompt2"><span class="n">cuda</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span></span>
<span class="prompt2"><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span></span>
<span class="prompt2"></span>
<span class="prompt2"><span class="c1"># Hyper-parameters</span></span>
<span class="prompt2"><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">200</span></span>
<span class="prompt2"><span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">80</span></span>
<span class="prompt2"><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-3</span></span>
<span class="prompt2"></span>
<span class="prompt2"><span class="c1"># Paths for different folders, data and result folders</span></span>
<span class="prompt2"><span class="n">datadir</span><span class="o">=</span><span class="s2">&quot;/home/pmpboy/Github/Data&quot;</span></span>
<span class="prompt2"><span class="n">wdir</span><span class="o">=</span><span class="s2">&quot;/home/pmpboy/Github/Result/Train_PN_result&quot;</span></span>
<span class="prompt2"><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wdir</span><span class="p">):</span></span>
<span class="prompt2">    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">wdir</span><span class="p">)</span></span>
</pre></div></div><ul class="simple">
<li><p>read in the training data:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">PN</span><span class="o">.</span><span class="n">readin_data_train</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span><span class="s2">&quot;TrainData_PmP_Net&quot;</span><span class="p">,</span><span class="n">batch_size</span><span class="p">)</span></span>
</pre></div></div><ul class="simple">
<li><p>train PmPNet:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">PN</span><span class="o">.</span><span class="n">NetTrain</span><span class="p">(</span><span class="n">wdir</span><span class="p">,</span><span class="s2">&quot;train_PN_log&quot;</span><span class="p">,</span><span class="s2">&quot;net_PN_model&quot;</span><span class="p">,</span><span class="n">train_loader</span><span class="p">,</span><span class="n">learning_rate</span><span class="p">,</span><span class="n">num_epochs</span><span class="p">,</span><span class="n">batch_size</span><span class="p">,</span><span class="n">device</span><span class="p">)</span></span>
</pre></div></div><p>We will see such output during training PmPNet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2">Epoch [1/80], Step [1/420] Loss1: 3.105050,Loss2: 1.987768,Loss3: 0.338054</span>
<span class="prompt2">Epoch [1/80], Step [101/420] Loss1: 0.527436,Loss2: 0.298014,Loss3: 0.143794</span>
<span class="prompt2">Epoch [1/80], Step [201/420] Loss1: 0.458504,Loss2: 0.414377,Loss3: 0.150728</span>
<span class="prompt2">Epoch [1/80], Step [301/420] Loss1: 0.396632,Loss2: 0.524836,Loss3: 0.144453</span>
<span class="prompt2">Epoch [1/80], Step [401/420] Loss1: 0.355758,Loss2: 0.687848,Loss3: 0.141200</span>
<span class="prompt2">Epoch [2/80], Step [1/420] Loss1: 0.371204,Loss2: 0.692910,Loss3: 0.128348</span>
<span class="prompt2">Epoch [2/80], Step [101/420] Loss1: 0.386219,Loss2: 0.625399,Loss3: 0.130919</span>
<span class="prompt2">Epoch [2/80], Step [201/420] Loss1: 0.307851,Loss2: 0.350751,Loss3: 0.122441</span>
<span class="prompt2">Epoch [2/80], Step [301/420] Loss1: 0.273838,Loss2: 0.373369,Loss3: 0.145047</span>
<span class="prompt2">Epoch [2/80], Step [401/420] Loss1: 0.279507,Loss2: 0.928377,Loss3: 0.130401</span>
<span class="prompt2">Epoch [3/80], Step [1/420] Loss1: 0.264289,Loss2: 0.560267,Loss3: 0.149387</span>
<span class="prompt2">Epoch [3/80], Step [101/420] Loss1: 0.269108,Loss2: 0.351606,Loss3: 0.130983</span>
<span class="prompt2">......</span>
</pre></div></div><ul class="simple">
<li><p>model evaluation on test data:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">PN</span><span class="o">.</span><span class="n">netevalu</span><span class="p">(</span><span class="n">wdir</span><span class="p">,</span><span class="s2">&quot;net_PN_model&quot;</span><span class="p">,</span><span class="s2">&quot;prcurve_file&quot;</span><span class="p">,</span><span class="s2">&quot;predict_PN_file&quot;</span><span class="p">,</span><span class="n">test_loader</span><span class="p">,</span><span class="n">device</span><span class="p">)</span></span>
</pre></div></div><ul class="simple">
<li><p>quickly visualize the result:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">PN</span><span class="o">.</span><span class="n">plot_modeva</span><span class="p">(</span><span class="n">wdir</span><span class="p">,</span><span class="s2">&quot;train_PN_log&quot;</span><span class="p">,</span><span class="s2">&quot;prcurve_file&quot;</span><span class="p">,</span><span class="s2">&quot;predict_PN_file&quot;</span><span class="p">,</span><span class="s2">&quot;plot_PN_modevalu&quot;</span><span class="p">)</span></span>
</pre></div></div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/plot_PN_modevalu.png"><img alt="Quickly Visualize the Performance of Trained PmPNet." src="../../_images/plot_PN_modevalu.png" style="width: 100.0%;" /></a>
</div>
<p><strong>Apply the pre-trained PmPNet to a certain year data</strong></p>
<ul class="simple">
<li><p>read in the real data:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">test_loader</span> <span class="o">=</span> <span class="n">PN</span><span class="o">.</span><span class="n">readin_data_real</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span><span class="s2">&quot;ValidationData_2015&quot;</span><span class="p">,</span><span class="n">batch_size</span><span class="p">)</span></span>
</pre></div></div><ul class="simple">
<li><p>predict probability the waveform contains a clear PmP phase and PmP traveltime:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">PN</span><span class="o">.</span><span class="n">netpredict</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span><span class="s2">&quot;ValidationData_2015&quot;</span><span class="p">,</span><span class="n">wdir</span><span class="p">,</span><span class="s2">&quot;net_PN_model&quot;</span><span class="p">,</span><span class="s2">&quot;predict_PN_file_2015&quot;</span><span class="p">,</span><span class="n">test_loader</span><span class="p">,</span><span class="n">device</span><span class="p">)</span></span>
</pre></div></div><p>We will see such output during the process:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2">NO.: 0   ID: 37272439   PmP_Prob: 0.323879  PmP_Time: 20.893116  dist: 127.9   evdp: 11.59   mag: 2.1  evtnm: 20151113_1204.CI.DTP</span>
<span class="prompt2">NO.: 1   ID: 37198399   PmP_Prob: 0.000000  PmP_Time: 17.361309  dist: 103.3   evdp: 18.04   mag: 2.3  evtnm: 20150705_1315.CI.SYN</span>
<span class="prompt2">NO.: 2   ID: 37150703   PmP_Prob: 0.000001  PmP_Time: 14.302899  dist: 76.6   evdp: 6.28   mag: 2.4  evtnm: 20150423_1454.CI.TOR</span>
<span class="prompt2">NO.: 3   ID: 37501608   PmP_Prob: 0.000037  PmP_Time: 13.073999  dist: 60.6   evdp: 2.31   mag: 2.2  evtnm: 20151214_0708.CI.DPP</span>
<span class="prompt2">NO.: 4   ID: 37508080   PmP_Prob: 0.000002  PmP_Time: 19.669258  dist: 111.8   evdp: 2.76   mag: 2.3  evtnm: 20151230_1027.CI.JVA</span>
<span class="prompt2">NO.: 5   ID: 37148391   PmP_Prob: 0.000000  PmP_Time: 16.840071  dist: 91.2   evdp: -0.18   mag: 2.3  evtnm: 20150420_0231.CI.HEC</span>
<span class="prompt2">NO.: 6   ID: 37305208   PmP_Prob: 0.000026  PmP_Time: 24.993418  dist: 151.4   evdp: 6.62   mag: 2.5  evtnm: 20150114_1203.CI.SYP</span>
<span class="prompt2">NO.: 7   ID: 37301936   PmP_Prob: 0.000000  PmP_Time: 26.983143  dist: 170.9   evdp: 8.30   mag: 2.5  evtnm: 20150104_0943.CI.GATR</span>
<span class="prompt2">NO.: 8   ID: 37402872   PmP_Prob: 0.000000  PmP_Time: 18.354214  dist: 102.4   evdp: 2.52   mag: 2.5  evtnm: 20150618_1256.CI.BLC</span>
<span class="prompt2">NO.: 9   ID: 37403528   PmP_Prob: 0.000005  PmP_Time: 19.624937  dist: 111.2   evdp: 1.40   mag: 2.2  evtnm: 20150619_0218.CI.RVR</span>
<span class="prompt2">......</span>
</pre></div></div><ul class="simple">
<li><p>quickly visualize the result:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">PN</span><span class="o">.</span><span class="n">plot_modpredict</span><span class="p">(</span><span class="n">wdir</span><span class="p">,</span><span class="s2">&quot;predict_PN_file_2015&quot;</span><span class="p">,</span><span class="s2">&quot;plot_PN_predict2015&quot;</span><span class="p">)</span></span>
</pre></div></div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/plot_PN_predict2015.png"><img alt="Quickly Visualize the Performance of Trained PmPNet." src="../../_images/plot_PN_predict2015.png" style="width: 100.0%;" /></a>
</div>
</div>
<div class="section" id="use-pmp-traveltime-net-to-predict-pmp-traveltime">
<h2>Use PmP-traveltime-Net to Predict PmP Traveltime<a class="headerlink" href="#use-pmp-traveltime-net-to-predict-pmp-traveltime" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Device configuration, Hyper-parameters setting, paths setting for data and result folders:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="kn">import</span> <span class="nn">torch</span></span>
<span class="prompt2"><span class="kn">import</span> <span class="nn">os</span></span>
<span class="prompt2"><span class="kn">import</span> <span class="nn">PmP_traveltime_Net</span> <span class="k">as</span> <span class="nn">PTN</span></span>
<span class="prompt2"></span>
<span class="prompt2"><span class="c1"># Device configuration</span></span>
<span class="prompt2"><span class="n">cuda</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span></span>
<span class="prompt2"><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span></span>
<span class="prompt2"></span>
<span class="prompt2"><span class="c1"># Hyper-parameters</span></span>
<span class="prompt2"><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span></span>
<span class="prompt2"><span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">200</span></span>
<span class="prompt2"><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">5e-4</span></span>
<span class="prompt2"></span>
<span class="prompt2"><span class="c1"># Paths for different folders, data and result folders</span></span>
<span class="prompt2"><span class="n">datadir</span><span class="o">=</span><span class="s2">&quot;/home/pmpboy/Github/Data&quot;</span></span>
<span class="prompt2"><span class="n">wdir</span><span class="o">=</span><span class="s2">&quot;/home/pmpboy/Github/Result/Train_PTN_result&quot;</span></span>
<span class="prompt2"><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wdir</span><span class="p">):</span></span>
<span class="prompt2">    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">wdir</span><span class="p">)</span></span>
</pre></div></div><ul class="simple">
<li><p>read in the training data:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">PTN</span><span class="o">.</span><span class="n">readin_data_train</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span><span class="s2">&quot;TrainData_PmP_traveltime_Net&quot;</span><span class="p">,</span><span class="n">batch_size</span><span class="p">)</span></span>
</pre></div></div><ul class="simple">
<li><p>train PmP-traveltime-Net:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">PTN</span><span class="o">.</span><span class="n">NetTrain</span><span class="p">(</span><span class="n">wdir</span><span class="p">,</span><span class="s2">&quot;train_PTN_log&quot;</span><span class="p">,</span><span class="s2">&quot;net_PTN_model&quot;</span><span class="p">,</span><span class="n">train_loader</span><span class="p">,</span><span class="n">learning_rate</span><span class="p">,</span><span class="n">num_epochs</span><span class="p">,</span><span class="n">batch_size</span><span class="p">,</span><span class="n">device</span><span class="p">)</span></span>
</pre></div></div><p>We will see such output during training PmP-traveltime-Net:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2">Epoch [1/200],  Step [1/63],  Loss: 1.060057</span>
<span class="prompt2">Epoch [1/200],  Step [51/63],  Loss: 0.161801</span>
<span class="prompt2">Epoch [2/200],  Step [1/63],  Loss: 0.125822</span>
<span class="prompt2">Epoch [2/200],  Step [51/63],  Loss: 0.120287</span>
<span class="prompt2">Epoch [3/200],  Step [1/63],  Loss: 0.093617</span>
<span class="prompt2">Epoch [3/200],  Step [51/63],  Loss: 0.084045</span>
<span class="prompt2">Epoch [4/200],  Step [1/63],  Loss: 0.073481</span>
<span class="prompt2">Epoch [4/200],  Step [51/63],  Loss: 0.077970</span>
<span class="prompt2">Epoch [5/200],  Step [1/63],  Loss: 0.104802</span>
<span class="prompt2">......</span>
</pre></div></div><ul class="simple">
<li><p>model evaluation on test data:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">PTN</span><span class="o">.</span><span class="n">netevalu</span><span class="p">(</span><span class="n">wdir</span><span class="p">,</span><span class="s2">&quot;net_PTN_model&quot;</span><span class="p">,</span><span class="s2">&quot;predict_PTN_file&quot;</span><span class="p">,</span><span class="n">test_loader</span><span class="p">,</span><span class="n">device</span><span class="p">)</span></span>
</pre></div></div><ul class="simple">
<li><p>quickly visualize the result:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">PTN</span><span class="o">.</span><span class="n">plot_modeva</span><span class="p">(</span><span class="n">wdir</span><span class="p">,</span><span class="s2">&quot;train_PTN_log&quot;</span><span class="p">,</span><span class="s2">&quot;predict_PTN_file&quot;</span><span class="p">,</span><span class="s2">&quot;plot_PTN_modevalu&quot;</span><span class="p">)</span></span>
</pre></div></div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/plot_PTN_modevalu.png"><img alt="Quickly Visualize the Performance of Trained PmPNet." src="../../_images/plot_PTN_modevalu.png" style="width: 100.0%;" /></a>
</div>
<p><strong>Apply the pre-trained PmP-traveltime-Net to a certain year data</strong></p>
<ul class="simple">
<li><p>read in the real data:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">test_loader</span> <span class="o">=</span> <span class="n">PTN</span><span class="o">.</span><span class="n">readin_data_real</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span><span class="s2">&quot;ValidationData_2015&quot;</span><span class="p">,</span><span class="n">batch_size</span><span class="p">)</span></span>
</pre></div></div><ul class="simple">
<li><p>give PmP traveltime prediction on real data:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">PTN</span><span class="o">.</span><span class="n">netpredict</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span><span class="s2">&quot;ValidationData_2015&quot;</span><span class="p">,</span><span class="n">wdir</span><span class="p">,</span><span class="s2">&quot;net_PTN_model&quot;</span><span class="p">,</span><span class="s2">&quot;predict_PTN_file_2015&quot;</span><span class="p">,</span><span class="n">test_loader</span><span class="p">,</span><span class="n">device</span><span class="p">)</span></span>
</pre></div></div><ul class="simple">
<li><p>quickly visualize the result:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2"><span class="n">PTN</span><span class="o">.</span><span class="n">plot_predict</span><span class="p">(</span><span class="n">wdir</span><span class="p">,</span><span class="s2">&quot;predict_PTN_file_2015&quot;</span><span class="p">,</span><span class="s2">&quot;plot_PTN_predict_2015&quot;</span><span class="p">)</span></span>
</pre></div></div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/plot_PTN_predict_2015.png"><img alt="Quickly Visualize the Performance of Trained PmPNet." src="../../_images/plot_PTN_predict_2015.png" style="width: 60.0%;" /></a>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../../PmP_database/Southern_California/index.html" class="btn btn-neutral float-right" title="Southern California" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../Phase_identification/index.html" class="btn btn-neutral float-left" title="Phase Identification" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright Since 2021, PmPBoy.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>